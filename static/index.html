<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RAG Chatbot</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
  <style>
    .chat-bubble {
      max-width: 75%;
      padding: 10px 14px;
      border-radius: 18px;
      margin-bottom: 10px;
      word-wrap: break-word;
      white-space: pre-wrap;
    }
    .bubble-user {
      background-color: #dcf8c6;
      align-self: flex-end;
    }
    .bubble-bot {
      background-color: #ffffff;
      border: 1px solid #ddd;
      align-self: flex-start;
    }
    .timestamp {
      font-size: 0.7rem;
      color: #888;
      margin-top: -6px;
      margin-bottom: 8px;
    }
    .notice {
      text-align: center;
      font-size: 0.9rem;
      color: #16a34a;
      margin: 8px 0;
    }
    .reactions {
      display: flex;
      gap: 6px;
      margin-top: 4px;
      margin-left: 6px;
    }
    .reaction {
      cursor: pointer;
      font-size: 1.1rem;
      opacity: 0.7;
      transition: transform 0.2s, opacity 0.2s;
    }
    .reaction:hover {
      transform: scale(1.2);
      opacity: 1;
    }
    .reaction.active {
      opacity: 1;
      font-weight: bold;
    }
  </style>
</head>
<body class="bg-gray-100 h-screen flex flex-col">

  <!-- Header with Upload -->
  <div class="bg-green-600 text-white p-3 flex items-center justify-between shadow">
    <h1 class="text-lg font-semibold">ü§ñ RAG Chatbot</h1>
    <form id="uploadForm" class="flex items-center space-x-2">
      <input type="file" id="fileInput" class="hidden" multiple />
      <label for="fileInput" class="cursor-pointer bg-white text-green-600 px-3 py-1 rounded shadow hover:bg-gray-100">
        üìÇ Upload Docs
      </label>
    </form>
  </div>

  <!-- Chat Container -->
  <div id="chatContainer" class="flex-1 overflow-y-auto p-4 flex flex-col bg-gray-50"></div>

  <!-- Input Area -->
  <div class="bg-white p-3 flex items-center border-t">
    <input id="userInput" type="text" placeholder="Type a message... üòä"
           class="flex-1 border rounded-full px-4 py-2 focus:outline-none focus:ring focus:ring-green-300" />
    <button id="sendBtn" class="ml-2 bg-green-600 text-white px-4 py-2 rounded-full shadow hover:bg-green-700">‚û§</button>
  </div>

  <script>
    const chatContainer = document.getElementById("chatContainer");
    const userInput = document.getElementById("userInput");
    const sendBtn = document.getElementById("sendBtn");
    const fileInput = document.getElementById("fileInput");

    let sessionId = null;

    function addMessage(text, isUser, isNotice = false) {
      if (isNotice) {
        const notice = document.createElement("div");
        notice.className = "notice";
        notice.textContent = text;
        chatContainer.appendChild(notice);
        chatContainer.scrollTop = chatContainer.scrollHeight;
        return;
      }

      const wrapper = document.createElement("div");
      wrapper.classList.add("flex", "flex-col");

      const bubble = document.createElement("div");
      bubble.classList.add("chat-bubble", isUser ? "bubble-user" : "bubble-bot");
      bubble.textContent = text;
      wrapper.appendChild(bubble);

      // Timestamp
      const ts = document.createElement("div");
      ts.className = "timestamp " + (isUser ? "self-end" : "self-start");
      ts.textContent = new Date().toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      wrapper.appendChild(ts);

      // Emoji reactions only for bot replies
      if (!isUser) {
        const reactionBar = document.createElement("div");
        reactionBar.className = "reactions";

        ["üëç", "‚ù§Ô∏è", "üòÇ", "üòÆ", "üëé"].forEach(emoji => {
          const span = document.createElement("span");
          span.className = "reaction";
          span.textContent = emoji;
          span.onclick = () => {
            reactionBar.querySelectorAll(".reaction").forEach(r => r.classList.remove("active"));
            span.classList.add("active");
          };
          reactionBar.appendChild(span);
        });

        wrapper.appendChild(reactionBar);
      }

      chatContainer.appendChild(wrapper);
      chatContainer.scrollTop = chatContainer.scrollHeight;
    }

    async function sendMessage() {
      const text = userInput.value.trim();
      if (!text) return;

      addMessage(text, true);
      userInput.value = "";

      const res = await fetch("/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ message: text, session_id: sessionId })
      });

      if (res.ok) {
        const data = await res.json();
        sessionId = data.session_id;
        addMessage(data.answer, false);
      } else {
        addMessage("‚ö†Ô∏è Error: Could not reach server", false);
      }
    }

    sendBtn.addEventListener("click", sendMessage);
    userInput.addEventListener("keypress", e => {
      if (e.key === "Enter") sendMessage();
    });

    // File Upload
    fileInput.addEventListener("change", async () => {
      if (fileInput.files.length === 0) return;

      const formData = new FormData();
      for (let f of fileInput.files) {
        formData.append("files", f);
      }

      const res = await fetch("/ingest", { method: "POST", body: formData });
      if (res.ok) {
        const data = await res.json();
        addMessage(`‚úÖ Uploaded successfully. ${data.chunks_added} chunks indexed. üöÄ`, false, true);
      } else {
        addMessage("‚ö†Ô∏è Upload failed", false, true);
      }
    });
  </script>
</body>
</html>
